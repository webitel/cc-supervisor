<template>
  <wt-page-wrapper>
    <template #header>
      <wt-headline>
        <template #title>
          {{ t('pages.queue.title') }}
        </template>
        <template #actions>
          <dynamic-filter-search
            :filters-manager="filtersManager"
            :is-filters-restoring="isFiltersRestoring"
            :value="searchValue"
            @filter:add="addFilter"
            @filter:update="updateFilter"
            @filter:delete="deleteFilter"
            @update:search-mode="updateSearchMode"
          />
          <wt-button
            :loading="isCSVLoading"
            :disabled="!dataList.length"
            @click="exportCSV"
          >{{ t('defaults.exportCSV') }}
          </wt-button>
        </template>
      </wt-headline>
    </template>
    <template #actions-panel>
      <queue-filters :namespace="filtersNamespace"/>
    </template>
    <template #main>
      <section class="main-section-wrapper">
        <wt-loader v-show="isLoading"></wt-loader>
        <div v-show="dataList?.length" class="table-wrapper">
          <wt-action-bar
            :include="[
              IconAction.REFRESH,
              IconAction.COLUMNS
            ]"
            class="table-wrapper__actions-wrapper"
            @click:refresh="loadDataList"
          >
            <template #columns>
              <wt-table-column-select
                :headers="headers"
                @change="updateShownHeaders"
              />
            </template>
          </wt-action-bar>

          <wt-table
            :headers="headers"
            :data="dataList"
            sortable
            :selectable="false"
            :grid-actions="false"
            @sort="updateSort"
          >
            <template #queue="{ item }">
              <table-queue :item="item" />
            </template>
            <template #agents="{ item }">
              <table-agents :status="item.agentStatus" />
            </template>
            <template #free="{ item }">
              <div v-if="item.agentStatus">
                {{ item.agentStatus.free }}
              </div>
            </template>
            <template #team="{ item }">
              <table-team :item="item" />
            </template>
            <template #members="{ item }">
              <table-members :item="item" />
            </template>
            <template #queue-footer>
              {{ t('reusable.total') }}
            </template>
            <template #agents-footer>
              <table-agents :status="aggs"/>
            </template>
            <template #free-footer>
              {{ aggs.free }}
            </template>
          </wt-table>

          <wt-pagination
            :next="next"
            :prev="page > 1"
            :size="size"
            debounce
            @change="updateSize"
            @next="updatePage(page + 1)"
            @prev="updatePage(page - 1)"
          />
        </div>
      </section>
    </template>
  </wt-page-wrapper>
</template>

<script setup>
import { DynamicFilterSearchComponent as DynamicFilterSearch } from '@webitel/ui-datalist/filters';
import IconAction from '@webitel/ui-sdk/src/enums/IconAction/IconAction.enum.js';
import { useCSVExport } from '@webitel/ui-sdk/src/modules/CSVExport/composables/useCSVExport';
import { storeToRefs } from 'pinia';
import { computed, onMounted, onUnmounted } from 'vue';
import { useI18n } from 'vue-i18n';
import { useTableAutoRefresh } from '../../../app/composables/useTableAutoRefresh';

import QueuesAPI from '../api/queues';
import QueueFilters from '../modules/filters/components/queue-filters.vue';
import { QueuesNamespace } from '../namespace';
import { useQueuesTableStore } from '../stores/queues';
import TableAgents from './_internals/table-templates/table-agents.vue';
import TableMembers from './_internals/table-templates/table-members.vue';
import TableQueue from './_internals/table-templates/table-queue.vue';
import TableTeam from './_internals/table-templates/table-team.vue';

const { t } = useI18n();

const tableStore = useQueuesTableStore();
const filtersNamespace = `${QueuesNamespace}/filters`;

const {
  dataList,
  isLoading,
  page,
  size,
  next,
  headers,
  isFiltersRestoring,
  filtersManager,
  selected,
  aggs,
} = storeToRefs(tableStore);

const {
  initialize,
  loadDataList,
  updatePage,
  updateSize,
  updateSort,
  updateShownHeaders,
  addFilter,
  updateFilter,
  deleteFilter,
  updateSearchMode,
} = tableStore;

const { exportCSV, isCSVLoading, initCSVExport } = useCSVExport({
  selected,
});

initCSVExport(QueuesAPI.getList, { filename: 'queues-stats' });

const searchValue = computed(() => filtersManager.value.filters.get('search')?.value || '');

const {
  setAutoRefresh,
  clearAutoRefresh,
} = useTableAutoRefresh(loadDataList)

initialize();

onMounted(() => {
  setAutoRefresh()
})

onUnmounted(() => {
  clearAutoRefresh()
})
</script>

<style lang="scss" scoped>
</style>
